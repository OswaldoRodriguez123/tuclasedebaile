angular.module("ui.mask",[]).value("uiMaskConfig",{maskDefinitions:{9:/\d/,A:/[a-zA-Z]/,"*":/[a-zA-Z0-9]/},clearOnBlur:!0,clearOnBlurPlaceholder:!1,escChar:"\\",eventsToHandle:["input","keyup","click","focus"],addDefaultPlaceholder:!0,allowInvalidValue:!1}).provider("uiMask.Config",function(){var e={};this.maskDefinitions=function(n){return e.maskDefinitions=n},this.clearOnBlur=function(n){return e.clearOnBlur=n},this.clearOnBlurPlaceholder=function(n){return e.clearOnBlurPlaceholder=n},this.eventsToHandle=function(n){return e.eventsToHandle=n},this.addDefaultPlaceholder=function(n){return e.addDefaultPlaceholder=n},this.allowInvalidValue=function(n){return e.allowInvalidValue=n},this.$get=["uiMaskConfig",function(n){var t=n;for(var a in e)angular.isObject(e[a])&&!angular.isArray(e[a])?angular.extend(t[a],e[a]):t[a]=e[a];return t}]}).directive("uiMask",["uiMask.Config",function(e){function n(e){return e===document.activeElement&&(!document.hasFocus||document.hasFocus())&&!!(e.type||e.href||~e.tabIndex)}return{priority:100,require:"ngModel",restrict:"A",compile:function(){var t=angular.copy(e);return function(e,a,i,r){function l(e){return angular.isDefined(e)?(b(e),N?(s(),f(),!0):c()):c()}function u(e){e&&(S=e,!N||0===a.val().length&&angular.isDefined(i.placeholder)||a.val(g(v(a.val()))))}function o(e){return N?(B=v(e||""),j=d(B),r.$setValidity("mask",j),B.length&&(j||G.allowInvalidValue)?g(B):void 0):e}function c(){return N=!1,h(),angular.isDefined(K)?a.attr("placeholder",K):a.removeAttr("placeholder"),angular.isDefined(Z)?a.attr("maxlength",Z):a.removeAttr("maxlength"),a.val(r.$modelValue),r.$viewValue=r.$modelValue,!1}function s(){B=R=v(r.$modelValue||""),I=H=g(B),j=d(B),i.maxlength&&a.attr("maxlength",2*x[x.length-1]),!K&&G.addDefaultPlaceholder&&a.attr("placeholder",S);for(var e=r.$modelValue,n=r.$formatters.length;n--;)e=r.$formatters[n](e);r.$viewValue=e||"",r.$render()}function f(){z||(a.bind("blur",k),a.bind("mousedown mouseup",y),a.bind("keydown",V),a.bind(G.eventsToHandle.join(" "),E),z=!0)}function h(){z&&(a.unbind("blur",k),a.unbind("mousedown",y),a.unbind("mouseup",y),a.unbind("keydown",V),a.unbind("input",E),a.unbind("keyup",E),a.unbind("click",E),a.unbind("focus",E),z=!1)}function d(e){return!e.length||e.length>=T}function v(e){var n,t,i="",r=a[0],l=C.slice(),u=_,o=u+P(r),c="";return e=e.toString(),n=0,t=e.length-S.length,angular.forEach(A,function(a){var i=a.position;i>=u&&i<o||(i>=u&&(i+=t),e.substring(i,i+a.value.length)===a.value&&(c+=e.slice(n,i),n=i+a.value.length))}),e=c+e.slice(n),angular.forEach(e.split(""),function(e){l.length&&l[0].test(e)&&(i+=e,l.shift())}),i}function g(e){var n="",t=x.slice();return angular.forEach(S.split(""),function(a,i){e.length&&i===t[0]?(n+=e.charAt(0)||"_",e=e.substr(1),t.shift()):n+=a}),n}function p(e){var n,t=angular.isDefined(i.uiMaskPlaceholder)?i.uiMaskPlaceholder:i.placeholder;return angular.isDefined(t)&&t[e]?t[e]:(n=angular.isDefined(i.uiMaskPlaceholderChar)&&i.uiMaskPlaceholderChar?i.uiMaskPlaceholderChar:"_","space"===n.toLowerCase()?" ":n[0])}function m(){var e,n=S.split("");x&&!isNaN(x[0])&&angular.forEach(x,function(e){n[e]="_"});var t=0;return(e=n.join("")).replace(/[_]+/g,"_").split("_").filter(function(e){return""!==e}).map(function(n){var a=e.indexOf(n,t);return t=a+1,{value:n,position:a}})}function b(e){var n=0;if(x=[],C=[],S="",angular.isString(e)){T=0;var t=!1,a=0,i=e.split(""),r=!1;angular.forEach(i,function(e,i){r?(r=!1,S+=e,n++):G.escChar===e?r=!0:G.maskDefinitions[e]?(x.push(n),S+=p(i-a),C.push(G.maskDefinitions[e]),n++,t||T++,t=!1):"?"===e?(t=!0,a++):(S+=e,n++)})}x.push(x.slice().pop()+1),A=m(),N=x.length>1}function k(){if((G.clearOnBlur||G.clearOnBlurPlaceholder&&0===B.length&&i.placeholder)&&(_=0,F=0,j&&0!==B.length||(I="",a.val(""),e.$apply(function(){r.$pristine||r.$setViewValue("")}))),B!==J){var n=a.val(),t=""===B&&n&&angular.isDefined(i.uiMaskPlaceholderChar)&&"space"===i.uiMaskPlaceholderChar;t&&a.val(""),w(a[0]),t&&a.val(n)}J=B}function w(e){var n;if(angular.isFunction(window.Event)&&!e.fireEvent)try{n=new Event("change",{view:window,bubbles:!0,cancelable:!1})}catch(e){(n=document.createEvent("HTMLEvents")).initEvent("change",!1,!0)}finally{e.dispatchEvent(n)}else"createEvent"in document?((n=document.createEvent("HTMLEvents")).initEvent("change",!1,!0),e.dispatchEvent(n)):e.fireEvent&&e.fireEvent("onchange")}function y(e){"mousedown"===e.type?a.bind("mouseout",$):a.unbind("mouseout",$)}function $(){F=P(this),a.unbind("mouseout",$)}function V(e){var n=8===e.which,t=O(this)-1||0,i=90===e.which&&e.ctrlKey;if(n){for(;t>=0;){if(M(t)){D(this,t+1);break}t--}L=-1===t}i&&(a.val(""),e.preventDefault())}function E(n){var t=(n=n||{}).which,i=n.type;if(16!==t&&91!==t){var l,u=a.val(),o=H,c=!1,s=v(u),f=R,h=O(this)||0,d=_||0,p=h-d,m=x[0],b=x[s.length]||x.slice().shift(),k=F||0,w=P(this)>0,y=k>0,$=u.length>o.length||k&&u.length>o.length-k,V=u.length<o.length||k&&u.length===o.length-k,E=t>=37&&t<=40&&n.shiftKey,C=37===t,A=8===t||"keyup"!==i&&V&&-1===p,T=46===t||"keyup"!==i&&V&&0===p&&!y,B=(C||A||"click"===i)&&h>m;if(F=P(this),!E&&(!w||"click"!==i&&"keyup"!==i&&"focus"!==i)){if(A&&L)return a.val(S),e.$apply(function(){r.$setViewValue("")}),void D(this,d);if("input"===i&&V&&!y&&s===f){for(;A&&h>m&&!M(h);)h--;for(;T&&h<b&&-1===x.indexOf(h);)h++;var I=x.indexOf(h);(s=s.substring(0,I)+s.substring(I+1))!==f&&(c=!0)}for(l=g(s),H=l,R=s,!c&&u.length>l.length&&(c=!0),a.val(l),c&&e.$apply(function(){r.$setViewValue(l)}),$&&h<=m&&(h=m+1),B&&h--,h=h>b?b:h<m?m:h;!M(h)&&h>m&&h<b;)h+=B?-1:1;(B&&h<b||$&&!M(d))&&h++,_=h,D(this,h)}}}function M(e){return x.indexOf(e)>-1}function O(e){if(!e)return 0;if(void 0!==e.selectionStart)return e.selectionStart;if(document.selection&&n(a[0])){e.focus();var t=document.selection.createRange();return t.moveStart("character",e.value?-e.value.length:0),t.text.length}return 0}function D(e,t){if(!e)return 0;if(0!==e.offsetWidth&&0!==e.offsetHeight)if(e.setSelectionRange)n(a[0])&&(e.focus(),e.setSelectionRange(t,t));else if(e.createTextRange){var i=e.createTextRange();i.collapse(!0),i.moveEnd("character",t),i.moveStart("character",t),i.select()}}function P(e){return e?void 0!==e.selectionStart?e.selectionEnd-e.selectionStart:window.getSelection?window.getSelection().toString().length:document.selection?document.selection.createRange().text.length:0:0}var x,C,S,A,T,B,I,j,H,R,_,F,L,N=!1,z=!1,K=i.placeholder,Z=i.maxlength,q=r.$isEmpty;r.$isEmpty=function(e){return q(N?v(e||""):e)};var W=!1;i.$observe("modelViewValue",function(e){"true"===e&&(W=!0)}),i.$observe("allowInvalidValue",function(e){G.allowInvalidValue=""===e||!!e,o(r.$modelValue)});var G={};i.uiOptions?(G=e.$eval("["+i.uiOptions+"]"),G=angular.isObject(G[0])?function(e,n){for(var t in e)Object.prototype.hasOwnProperty.call(e,t)&&(void 0===n[t]?n[t]=angular.copy(e[t]):angular.isObject(n[t])&&!angular.isArray(n[t])&&(n[t]=angular.extend({},e[t],n[t])));return n}(t,G[0]):t):G=t,i.$observe("uiMask",l),angular.isDefined(i.uiMaskPlaceholder)?i.$observe("uiMaskPlaceholder",u):i.$observe("placeholder",u),angular.isDefined(i.uiMaskPlaceholderChar)&&i.$observe("uiMaskPlaceholderChar",function(){return l(i.uiMask)}),r.$formatters.unshift(o),r.$parsers.unshift(function(e){return N?(B=v(e||""),j=d(B),r.$viewValue=B.length?g(B):"",r.$setValidity("mask",j),j||G.allowInvalidValue?W?r.$viewValue:B:void 0):e});var J=a.val();a.bind("mousedown mouseup",y),Array.prototype.indexOf||(Array.prototype.indexOf=function(e){if(null===this)throw new TypeError;var n=Object(this),t=n.length>>>0;if(0===t)return-1;var a=0;if(arguments.length>1&&((a=Number(arguments[1]))!==a?a=0:0!==a&&a!==1/0&&a!==-1/0&&(a=(a>0||-1)*Math.floor(Math.abs(a)))),a>=t)return-1;for(var i=a>=0?a:Math.max(t-Math.abs(a),0);i<t;i++)if(i in n&&n[i]===e)return i;return-1})}}}}]);